<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Class Chat Rooms - Teacher Bot Assistant</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app-container">
    <!-- Left Sidebar: Chats List -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">CH</div>
        <h2 style="margin:0;font-size:18px;color:#fff">Chat</h2>
      </div>
      <div class="search">
        <span>üîç</span>
        <span>Search</span>
      </div>
      <div class="chats">
        <div class="chat-item" data-page="index.html">
          <div class="avatar">üßô</div>
          <div class="meta">
            <div class="name">Sage - AI Assistant</div>
            <div class="last">Let me help you with that...</div>
          </div>
        </div>
        <div class="chat-item" data-page="login.html">
          <div class="avatar">üë§</div>
          <div class="meta">
            <div class="name">Profile / Logout</div>
            <div class="last">View your profile</div>
          </div>
        </div>
        <div class="chat-item" data-page="topics.html">
          <div class="avatar">üìö</div>
          <div class="meta">
            <div class="name">Teacher Tools</div>
            <div class="last">Browse topics and resources</div>
          </div>
        </div>
        <div class="chat-item" data-page="newpost.html">
          <div class="avatar">üìù</div>
          <div class="meta">
            <div class="name">New Post</div>
            <div class="last">Create a new post...</div>
          </div>
        </div>
        <div class="chat-item active" data-page="classrooms.html">
          <div class="avatar">üè´</div>
          <div class="meta">
            <div class="name">Class Chat Rooms</div>
            <div class="last">Join your class</div>
          </div>
        </div>
        <div class="chat-item" data-page="newstudent.html">
          <div class="avatar">üéì</div>
          <div class="meta">
            <div class="name">Students</div>
            <div class="last">Add new student</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Center: Class Selection -->
    <div class="chat-area" id="class-selection-view">
      <div class="topbar">
        <div class="title">
          <div>
            <h2>Join a Class Chat Room</h2>
            <p>Select your class to request access</p>
          </div>
        </div>
      </div>

      <div class="messages-wrap" style="justify-content:center;align-items:center">
        <div class="class-grid" id="class-grid">
          <!-- Classes will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Center: Class Chat (hidden initially) -->
    <div class="chat-area" id="class-chat-view" style="display:none">
      <div class="topbar">
        <div class="title">
          <div>
            <h2 id="class-name-header">Class Name</h2>
            <p id="class-teacher-header">Teacher: </p>
          </div>
        </div>
        <button id="leave-class-btn" style="background:rgba(255,0,0,0.1);border:none;padding:10px 20px;border-radius:8px;color:#ff4444;cursor:pointer;font-weight:600">Leave Class</button>
      </div>

      <div class="messages-wrap">
        <div class="messages" id="class-messages">
          <!-- Messages will appear here -->
        </div>
      </div>

      <!-- Bottom Input Composer -->
      <div class="composer">
        <textarea id="class-chat-input" placeholder="Type your message..." rows="1"></textarea>
        <button id="send-class-msg-btn">Send</button>
      </div>
    </div>

    <!-- Right Details Panel -->
    <aside class="details">
      <h3>CLASS INFORMATION</h3>
      
      <div class="card" id="pending-requests-card" style="display:none">
        <h4 style="margin:0 0 8px 0;font-size:14px">Pending Requests</h4>
        <div id="pending-requests-list"></div>
      </div>

      <div class="card">
        <h4 style="margin:0 0 8px 0;font-size:14px">Available Classes</h4>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px" id="class-list-sidebar">
          <!-- Classes will be listed here -->
        </div>
      </div>

      <div class="card">
        <h4 style="margin:0 0 8px 0;font-size:14px">My Classes</h4>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px" id="my-classes-list">
          <div style="color:var(--muted)">No classes joined yet</div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // Mock database for classes
    const availableClasses = [
      { id: 'math-101', name: 'Mathematics 101', teacher: 'Mr. Smith', subject: 'üìê Math', students: 24 },
      { id: 'science-201', name: 'Science Advanced', teacher: 'Dr. Johnson', subject: 'üî¨ Science', students: 18 },
      { id: 'history-101', name: 'World History', teacher: 'Ms. Davis', subject: 'üèõÔ∏è History', students: 30 },
      { id: 'english-101', name: 'English Literature', teacher: 'Mrs. Brown', subject: 'üìñ English', students: 22 },
      { id: 'cs-101', name: 'Computer Science', teacher: 'Dr. Wilson', subject: 'üíª CS', students: 15 }
    ];

    let currentClass = null;
    let joinedClasses = JSON.parse(localStorage.getItem('joinedClasses')) || [];
    let pendingRequests = JSON.parse(localStorage.getItem('pendingRequests')) || [];

    function loadClassGrid() {
      const grid = document.getElementById('class-grid');
      grid.innerHTML = '';

      availableClasses.forEach(cls => {
        const isJoined = joinedClasses.includes(cls.id);
        const isPending = pendingRequests.includes(cls.id);

        const classCard = document.createElement('div');
        classCard.className = 'class-card';
        classCard.innerHTML = `
          <div class="class-icon">${cls.subject.split(' ')[0]}</div>
          <h3>${cls.name}</h3>
          <p>Teacher: ${cls.teacher}</p>
          <p>${cls.students} students</p>
          <button class="class-btn ${isJoined ? 'joined' : isPending ? 'pending' : ''}" 
                  data-class-id="${cls.id}">
            ${isJoined ? 'Enter Class' : isPending ? 'Pending...' : 'Request to Join'}
          </button>
        `;

        const btn = classCard.querySelector('.class-btn');
        btn.addEventListener('click', () => {
          if (isJoined) {
            enterClass(cls);
          } else if (!isPending) {
            requestToJoinClass(cls);
          }
        });

        grid.appendChild(classCard);
      });
    }

    function requestToJoinClass(cls) {
      if (confirm(`Request to join ${cls.name}?\n\nYour request will be sent to ${cls.teacher} for approval.`)) {
        pendingRequests.push(cls.id);
        localStorage.setItem('pendingRequests', JSON.stringify(pendingRequests));
        alert(`Request sent to ${cls.teacher}!\n\nYou'll be notified when approved.`);
        loadClassGrid();
        loadSidebar();
      }
    }

    function enterClass(cls) {
      currentClass = cls;
      document.getElementById('class-selection-view').style.display = 'none';
      document.getElementById('class-chat-view').style.display = 'flex';
      document.getElementById('class-name-header').textContent = cls.name;
      document.getElementById('class-teacher-header').textContent = `Teacher: ${cls.teacher}`;
      
      loadClassMessages(cls.id);
    }

    function loadClassMessages(classId) {
      const messages = JSON.parse(localStorage.getItem(`class-messages-${classId}`)) || [];
      const container = document.getElementById('class-messages');
      container.innerHTML = '';

      if (messages.length === 0) {
        container.innerHTML = `
          <div class="message-row incoming">
            <div class="avatar-small">üë®‚Äçüè´</div>
            <div class="msg incoming">
              <div>Welcome to ${currentClass.name}! Feel free to ask questions and participate in discussions.</div>
              <div class="meta"><span>${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span></div>
            </div>
          </div>
        `;
      } else {
        messages.forEach(msg => {
          addMessageToChat(msg.sender, msg.text, msg.time, msg.isTeacher, msg.isSage);
        });
      }
    }

    function addMessageToChat(sender, text, time, isTeacher = false, isSage = false) {
      const container = document.getElementById('class-messages');
      const messageRow = document.createElement('div');
      messageRow.className = `message-row ${sender === 'You' ? 'outgoing' : 'incoming'}`;

      if (sender === 'You') {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg outgoing';
        msgDiv.innerHTML = `
          <div>${text}</div>
          <div class="meta"><span>${time}</span></div>
        `;
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar-small';
        avatarDiv.textContent = 'üë§';
        messageRow.appendChild(msgDiv);
        messageRow.appendChild(avatarDiv);
      } else {
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar-small';
        avatarDiv.textContent = isSage ? 'üßô' : (isTeacher ? 'üë®‚Äçüè´' : 'üë•');
        avatarDiv.style.background = isSage ? 'linear-gradient(135deg, #10b981, #059669)' : '';
        
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg incoming';
        if (isSage) {
          msgDiv.style.borderLeft = '3px solid #10b981';
          msgDiv.style.background = 'linear-gradient(90deg, rgba(16,185,129,0.1), rgba(15,41,46,0.5))';
        }
        msgDiv.innerHTML = `
          <div><strong>${sender}:</strong> ${text}</div>
          <div class="meta"><span>${time}</span></div>
        `;
        messageRow.appendChild(avatarDiv);
        messageRow.appendChild(msgDiv);
      }

      container.appendChild(messageRow);
      container.scrollTop = container.scrollHeight;
    }

    document.getElementById('send-class-msg-btn')?.addEventListener('click', () => {
      const input = document.getElementById('class-chat-input');
      const text = input.value.trim();
      if (!text || !currentClass) return;

      const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      addMessageToChat('You', text, time);

      // Save to localStorage
      const messages = JSON.parse(localStorage.getItem(`class-messages-${currentClass.id}`)) || [];
      messages.push({ sender: 'You', text, time, isTeacher: false });
      localStorage.setItem(`class-messages-${currentClass.id}`, JSON.stringify(messages));

      input.value = '';

      // Check if Sage is summoned
      if (text.toLowerCase().includes('summon sage')) {
        // Play magical portal animation
        createPortalAnimation();
        
        setTimeout(() => {
          const sageResponse = getSageResponse(text);
          const sageTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          addMessageToChat('üßô Sage AI', sageResponse, sageTime, false, true);
          
          // Save Sage's response
          const updatedMessages = JSON.parse(localStorage.getItem(`class-messages-${currentClass.id}`)) || [];
          updatedMessages.push({ sender: 'üßô Sage AI', text: sageResponse, time: sageTime, isTeacher: false, isSage: true });
          localStorage.setItem(`class-messages-${currentClass.id}`, JSON.stringify(updatedMessages));
        }, 2000);
      }
    });

    function createPortalAnimation() {
      const portalContainer = document.createElement('div');
      portalContainer.className = 'portal-container';
      
      // Create main portal
      const portal = document.createElement('div');
      portal.className = 'portal';
      portalContainer.appendChild(portal);
      
      // Create sparkles (white dots)
      for (let i = 0; i < 30; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        const angle = (Math.PI * 2 * i) / 30;
        const distance = 60 + Math.random() * 120;
        sparkle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        sparkle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        sparkle.style.animationDelay = `${i * 0.04}s`;
        portalContainer.appendChild(sparkle);
      }
      
      // Create stars (‚ú® emoji)
      const starEmojis = ['‚ú®', '‚≠ê', 'üí´', 'üåü'];
      for (let i = 0; i < 12; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.textContent = starEmojis[i % starEmojis.length];
        const angle = (Math.PI * 2 * i) / 12;
        const distance = 70 + Math.random() * 100;
        star.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        star.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        star.style.animationDelay = `${i * 0.1}s`;
        portalContainer.appendChild(star);
      }
      
      // Create Sage emoji emerging from portal
      const sage = document.createElement('div');
      sage.className = 'sage-summoned';
      sage.textContent = 'üßô‚Äç‚ôÇÔ∏è';
      portalContainer.appendChild(sage);
      
      document.body.appendChild(portalContainer);
      
      // Remove animation after completion
      setTimeout(() => {
        portalContainer.style.transition = 'opacity 0.5s ease-out';
        portalContainer.style.opacity = '0';
        setTimeout(() => portalContainer.remove(), 500);
      }, 2500);
    }

    function getSageResponse(query) {
      const lowerQuery = query.toLowerCase();
      
      // Greeting responses
      if (lowerQuery.includes('hello') || lowerQuery.includes('hi')) {
        return "Hello! I'm Sage, your AI teaching assistant. I've been summoned to help! What can I do for you?";
      }
      
      // Subject-specific help
      if (lowerQuery.includes('math')) {
        return "I can help with math! Whether it's algebra, geometry, calculus, or any other math topic, I'm here to assist. What specific topic do you need help with?";
      }
      
      if (lowerQuery.includes('science')) {
        return "Science is fascinating! I can help with physics, chemistry, biology, and earth science. What would you like to explore?";
      }
      
      if (lowerQuery.includes('history')) {
        return "History helps us understand our past! I can provide information on ancient civilizations, world wars, medieval times, and modern history. What period interests you?";
      }
      
      if (lowerQuery.includes('english') || lowerQuery.includes('literature')) {
        return "Literature enriches our minds! I can help with poetry analysis, novels, drama, and creative writing. What literary topic shall we discuss?";
      }
      
      if (lowerQuery.includes('homework') || lowerQuery.includes('assignment')) {
        return "I can help guide you through your homework! Please share the specific question or topic, and I'll provide explanations and resources to help you understand it better.";
      }
      
      if (lowerQuery.includes('lesson plan')) {
        return "I'd be happy to help create a lesson plan! Please tell me: 1) What subject/topic? 2) What grade level? 3) Any specific learning objectives?";
      }
      
      // Default response
      return "I'm here to help! As your AI teaching assistant, I can provide explanations, resources, and guidance on various subjects. Feel free to ask me about math, science, history, literature, or any educational topic. How can I assist you today?";
    }

    document.getElementById('leave-class-btn')?.addEventListener('click', () => {
      if (confirm('Leave this class chat?')) {
        currentClass = null;
        document.getElementById('class-selection-view').style.display = 'flex';
        document.getElementById('class-chat-view').style.display = 'none';
      }
    });

    function loadSidebar() {
      const sidebar = document.getElementById('class-list-sidebar');
      sidebar.innerHTML = '';
      availableClasses.forEach(cls => {
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;gap:8px;align-items:center;cursor:pointer;padding:6px;border-radius:6px';
        div.innerHTML = `<span>${cls.subject.split(' ')[0]}</span><span>${cls.name}</span>`;
        div.addEventListener('mouseenter', () => div.style.background = 'rgba(255,255,255,0.05)');
        div.addEventListener('mouseleave', () => div.style.background = 'transparent');
        sidebar.appendChild(div);
      });

      const myClasses = document.getElementById('my-classes-list');
      myClasses.innerHTML = '';
      if (joinedClasses.length === 0) {
        myClasses.innerHTML = '<div style="color:var(--muted)">No classes joined yet</div>';
      } else {
        joinedClasses.forEach(classId => {
          const cls = availableClasses.find(c => c.id === classId);
          if (cls) {
            const div = document.createElement('div');
            div.style.cssText = 'display:flex;gap:8px;align-items:center;cursor:pointer;padding:6px;border-radius:6px';
            div.innerHTML = `<span>${cls.subject.split(' ')[0]}</span><span>${cls.name}</span>`;
            div.addEventListener('click', () => enterClass(cls));
            div.addEventListener('mouseenter', () => div.style.background = 'rgba(59,130,246,0.1)');
            div.addEventListener('mouseleave', () => div.style.background = 'transparent');
            myClasses.appendChild(div);
          }
        });
      }
    }

    // Navigation
    document.querySelectorAll('.chat-item').forEach(item => {
      item.addEventListener('click', function() {
        const page = this.getAttribute('data-page');
        if (page && page !== 'classrooms.html') {
          window.location.href = page;
        }
      });
    });

    // Initialize
    loadClassGrid();
    loadSidebar();

    // Demo: Auto-approve first pending request after 5 seconds
    if (pendingRequests.length > 0 && !joinedClasses.includes(pendingRequests[0])) {
      setTimeout(() => {
        const approvedId = pendingRequests[0];
        joinedClasses.push(approvedId);
        pendingRequests = pendingRequests.filter(id => id !== approvedId);
        localStorage.setItem('joinedClasses', JSON.stringify(joinedClasses));
        localStorage.setItem('pendingRequests', JSON.stringify(pendingRequests));
        
        const approvedClass = availableClasses.find(c => c.id === approvedId);
        if (approvedClass) {
          alert(`‚úÖ Request Approved!\n\nYou've been accepted into ${approvedClass.name} by ${approvedClass.teacher}!`);
          loadClassGrid();
          loadSidebar();
        }
      }, 5000);
    }
  </script>

  <style>
    .class-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 30px;
      width: 100%;
      max-width: 1000px;
    }

    .class-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .class-card:hover {
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border-color: rgba(59,130,246,0.3);
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(59,130,246,0.15);
    }

    .class-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      box-shadow: 0 8px 20px rgba(59,130,246,0.2);
    }

    .class-card h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: #e6eef6;
    }

    .class-card p {
      margin: 4px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .class-btn {
      margin-top: 16px;
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      width: 100%;
      transition: all 0.2s ease;
    }

    .class-btn:hover {
      background: #1d4ed8;
      transform: scale(1.05);
    }

    .class-btn.joined {
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .class-btn.pending {
      background: #6b7280;
      cursor: not-allowed;
    }
  </style>
</body>
</html>