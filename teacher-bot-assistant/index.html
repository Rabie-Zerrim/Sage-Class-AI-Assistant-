<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat with Sage - Teacher Bot Assistant</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app-container">
    <!-- Left Sidebar: Chats List -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">CH</div>
        <h2 style="margin:0;font-size:18px;color:#fff">Chat</h2>
      </div>
      <div class="search">
        <span>ğŸ”</span>
        <span>Search</span>
      </div>
      <div class="chats">
        <div class="chat-item active" data-page="index.html">
          <div class="avatar">ğŸ§™</div>
          <div class="meta">
            <div class="name">Sage - AI Assistant</div>
            <div class="last">Let me help you with that...</div>
          </div>
        </div>
        <div class="chat-item" data-page="teacher-dashboard.html" id="teacher-dashboard-link">
          <div class="avatar">ï¿½â€ğŸ«</div>
          <div class="meta">
            <div class="name">Teacher Dashboard</div>
            <div class="last">Manage courses & files</div>
          </div>
        </div>
        <div class="chat-item" data-page="topics.html">
          <div class="avatar">ğŸ“š</div>
          <div class="meta">
            <div class="name">Teacher Tools</div>
            <div class="last">Browse topics and resources</div>
          </div>
        </div>
        <div class="chat-item" data-page="newpost.html">
          <div class="avatar">ğŸ“</div>
          <div class="meta">
            <div class="name">New Post</div>
            <div class="last">Create a new post...</div>
          </div>
        </div>
        <div class="chat-item" data-page="classrooms.html">
          <div class="avatar">ğŸ«</div>
          <div class="meta">
            <div class="name">Class Chat Rooms</div>
            <div class="last">Join your class</div>
          </div>
        </div>
        <div class="chat-item" data-page="newstudent.html" id="students-link">
          <div class="avatar">ğŸ“</div>
          <div class="meta">
            <div class="name">Students</div>
            <div class="last">Add new student</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Center: Chat Area -->
    <div class="chat-area">
      <div class="topbar">
        <div class="title">
          <div style="display:flex;align-items:center;gap:16px">
            <div class="sage-avatar" id="sage-avatar">
              <div class="sage-image-container">
                <img src="sage.png" alt="Sage" class="sage-pixel-art" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                     style="width:100%;height:100%;object-fit:cover;image-rendering:pixelated;border-radius:50%">
                <div class="sage-pixel-art" style="display:none;font-size:42px">ğŸ§™</div>
              </div>
            </div>
            <div>
              <h2>Sage - AI Teaching Assistant</h2>
              <p><span id="sage-status">Online</span> â€¢ Ready to help</p>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:12px;">
          <button style="background:rgba(255,255,255,0.03);border:none;padding:10px 14px;border-radius:8px;color:#9aa4b2;cursor:pointer">ğŸ“</button>
          <button style="background:rgba(255,255,255,0.03);border:none;padding:10px 14px;border-radius:8px;color:#9aa4b2;cursor:pointer">ğŸ“¹</button>
          <button style="background:rgba(255,255,255,0.03);border:none;padding:10px 14px;border-radius:8px;color:#9aa4b2;cursor:pointer">âš™ï¸</button>
        </div>
      </div>

      <div class="messages-wrap">
        <div class="messages" id="chat-output">
          <!-- Sample Messages -->
          <div class="message-row incoming">
            <div class="avatar-small">ï¿½</div>
            <div class="msg incoming">
              <div>Hello! I'm Sage, your AI teaching assistant. How can I help you today?</div>
              <div class="meta">
                <span>08:57</span>
              </div>
            </div>
          </div>

          <div class="message-row outgoing">
            <div class="msg outgoing">
              <div>I need help creating a lesson plan for teaching fractions to 5th graders</div>
              <div class="meta">
                <span>ğŸ‘ï¸ 3</span>
                <span>09:00</span>
              </div>
            </div>
            <div class="avatar-small">ğŸ‘¤</div>
          </div>

          <div class="message-row incoming">
            <div class="avatar-small">ğŸ§™</div>
            <div class="msg incoming">
              <div>Great! I can help you with that. Here's a comprehensive lesson plan for teaching fractions:<br><br>
              <strong>Objective:</strong> Students will understand the concept of fractions and be able to identify, compare, and create visual representations.<br><br>
              <strong>Materials:</strong> Paper, colored pencils, fraction manipulatives, pizza images</div>
              <div class="meta">
                <span>09:01</span>
              </div>
            </div>
          </div>

          <div class="message-row outgoing">
            <div class="msg outgoing">
              <div>This is perfect! Do you have any video resources I could use?</div>
              <div class="meta">
                <span>ğŸ‘ï¸ 2</span>
                <span>09:03</span>
              </div>
            </div>
            <div class="avatar-small">ğŸ‘¤</div>
          </div>
        </div>
      </div>

      <!-- Bottom Input Composer -->
      <div class="composer">
        <textarea id="chat-input" placeholder="Your message" rows="1"></textarea>
        <button id="submit-btn">Send</button>
      </div>
    </div>

    <!-- Right Details Panel -->
    <aside class="details">
      <h3>CHAT DETAILS</h3>
      
      <div class="card" style="background: rgba(31, 41, 51, 0.6); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <h4 style="margin:0;font-size:14px;color:#fff">ğŸ“¸ Photos & Media</h4>
          <span style="color: #60a5fa; font-size: 12px; cursor: pointer;" id="upload-media-btn">+ Upload</span>
        </div>
        <div id="media-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px">
          <!-- Media will be loaded here -->
        </div>
      </div>

      <div class="card" style="background: rgba(31, 41, 51, 0.6); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <h4 style="margin:0;font-size:14px;color:#fff">ğŸ“ Shared Files</h4>
          <span style="color: #60a5fa; font-size: 12px; cursor: pointer;" id="upload-file-btn">+ Upload</span>
        </div>
        <div id="files-list" style="display:flex;flex-direction:column;gap:8px;font-size:13px;max-height:200px;overflow-y:auto">
          <!-- Files will be loaded here -->
        </div>
      </div>

      <div class="card" style="background: rgba(31, 41, 51, 0.6); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <h4 style="margin:0 0 10px 0;font-size:14px;color:#fff">ğŸ“… This Week's Schedule</h4>
        <div id="week-schedule" style="font-size: 13px; color: #94a3b8;">
          <!-- Schedule will be loaded here -->
        </div>
      </div>

      <div class="card" style="background: rgba(31, 41, 51, 0.6); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <h4 style="margin:0 0 8px 0;font-size:14px;color:#fff">ğŸ”— Shared Links</h4>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px">
          <div style="display:flex;gap:8px;align-items:center;color:#94a3b8">
            <span>ğŸ”—</span>
            <span>Khan Academy - Fractions</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;color:#94a3b8">
            <span>ğŸ”—</span>
            <span>Math Learning Resources</span>
          </div>
        </div>
      </div>

      <div id="slide-list" class="slide-list" style="display:none"></div>
      <div id="video-list" class="video-list" style="display:none"></div>
    </aside>
  </div>
  
  <!-- Hidden file input -->
  <input type="file" id="hidden-file-input" multiple accept="image/*,application/pdf,.doc,.docx" style="display: none;">
  <input type="file" id="hidden-media-input" multiple accept="image/*,video/*" style="display: none;">
  
  <script src="./auth.js"></script>
  <script src="./filemanager.js"></script>
  <script src="./schedule.js"></script>
  <script src="./script.js"></script>
  <script>
    // Check authentication
    const currentUser = checkAuth();
    if (currentUser) {
      console.log('Logged in as:', currentUser.name, '-', currentUser.role);
      
      // Hide teacher dashboard for students
      if (currentUser.role === 'student') {
        const teacherLink = document.getElementById('teacher-dashboard-link');
        if (teacherLink) teacherLink.style.display = 'none';
      }
    }
    
    // Load media files
    function loadMedia() {
      const images = getImages();
      const grid = document.getElementById('media-grid');
      grid.innerHTML = '';
      
      if (images.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #94a3b8; font-size: 12px;">No media yet</p>';
        return;
      }
      
      images.slice(0, 6).forEach(img => {
        const div = document.createElement('div');
        div.style = 'background:#1f2933;border-radius:8px;aspect-ratio:1;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden';
        if (img.preview) {
          div.innerHTML = `<img src="${img.preview}" style="width:100%;height:100%;object-fit:cover">`;
        } else {
          div.textContent = 'ğŸ–¼ï¸';
        }
        grid.appendChild(div);
      });
    }
    
    // Load files
    function loadFilesList() {
      const files = getFiles({ category: 'document' });
      const list = document.getElementById('files-list');
      list.innerHTML = '';
      
      if (files.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #94a3b8; font-size: 12px;">No files yet</p>';
        return;
      }
      
      files.forEach(file => {
        const div = document.createElement('div');
        div.style = 'display:flex;gap:8px;align-items:center;color:#94a3b8;cursor:pointer;padding:8px;border-radius:6px;transition:background 0.2s';
        div.innerHTML = `
          <span>${getFileIcon(file.type)}</span>
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${file.name}</span>
        `;
        div.onmouseover = () => div.style.background = 'rgba(59, 130, 246, 0.1)';
        div.onmouseout = () => div.style.background = 'transparent';
        list.appendChild(div);
      });
    }
    
    function getFileIcon(type) {
      if (type.includes('pdf')) return 'ğŸ“„';
      if (type.includes('word')) return 'ğŸ“';
      if (type.includes('image')) return 'ğŸ–¼ï¸';
      return 'ğŸ“';
    }
    
    // Load weekly schedule
    function loadWeekSchedule() {
      const weekNum = getCurrentWeekNumber();
      const schedule = getSchedule('general', weekNum);
      const container = document.getElementById('week-schedule');
      
      if (!schedule) {
        container.innerHTML = '<p style="font-size: 12px;">No schedule uploaded for this week.</p>';
        return;
      }
      
      container.innerHTML = `
        <div style="color: #60a5fa; font-size: 12px; margin-bottom: 8px;">Week ${weekNum}</div>
        <div style="color: #94a3b8;">Schedule uploaded by ${schedule.uploadedBy}</div>
      `;
    }
    
    // File upload handlers
    document.getElementById('upload-file-btn').addEventListener('click', () => {
      if (!hasPermission('upload')) {
        alert('Only teachers can upload files');
        return;
      }
      document.getElementById('hidden-file-input').click();
    });
    
    document.getElementById('upload-media-btn').addEventListener('click', () => {
      if (!hasPermission('upload')) {
        alert('Only teachers can upload media');
        return;
      }
      document.getElementById('hidden-media-input').click();
    });
    
    document.getElementById('hidden-file-input').addEventListener('change', function(e) {
      Array.from(e.target.files).forEach(file => {
        uploadFile(file, { category: 'document' });
      });
      this.value = '';
      loadFilesList();
    });
    
    document.getElementById('hidden-media-input').addEventListener('change', function(e) {
      Array.from(e.target.files).forEach(file => {
        uploadFile(file, { category: 'image' });
      });
      this.value = '';
      loadMedia();
    });
    
    // Initial load
    loadMedia();
    loadFilesList();
    loadWeekSchedule();
    
    // Hide Students tab for non-teachers
    const currentUser = getCurrentUser();
    if (currentUser && currentUser.role !== 'teacher') {
      const studentsLink = document.getElementById('students-link');
      if (studentsLink) {
        studentsLink.style.display = 'none';
      }
    }
  </script>
</body>
</html>
